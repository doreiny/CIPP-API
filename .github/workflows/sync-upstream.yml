name: Sync upstream CIPP-API (keep local workflows)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # פעם ביום (UTC)

permissions:
  contents: write

concurrency:
  group: sync-upstream-cipp-api
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Backup local workflows (we will keep ours)
        run: |
          mkdir -p /tmp/local-workflows
          if [ -d ".github/workflows" ]; then
            rsync -a ".github/workflows/" "/tmp/local-workflows/"
          fi

      - name: Add upstream & fetch
        run: |
          git remote add upstream https://github.com/KelvinTegelaar/CIPP-API.git 2>/dev/null || true
          git fetch upstream master --prune

      - name: Merge upstream/master into master (prefer upstream, but keep local workflows)
        run: |
          set -euo pipefail
          git checkout master

          # מתחילים merge בלי commit אוטומטי כדי שנוכל להגן על workflows
          git merge --no-commit --no-ff -X theirs upstream/master || true

          # אם יש קונפליקטים:
          # - על .github/workflows ניקח "ours" (הגרסה המקומית שלך)
          # - על כל השאר ניקח "theirs" (ה-upstream)
          CONFLICTS=$(git diff --name-only --diff-filter=U || true)
          if [ -n "${CONFLICTS}" ]; then
            echo "Conflicts detected:"
            echo "${CONFLICTS}"

            WF_CONFLICTS=$(echo "${CONFLICTS}" | grep -E '^\.github/workflows/' || true)
            OTHER_CONFLICTS=$(echo "${CONFLICTS}" | grep -vE '^\.github/workflows/' || true)

            if [ -n "${WF_CONFLICTS}" ]; then
              echo "Resolving workflow conflicts by keeping LOCAL (ours):"
              echo "${WF_CONFLICTS}"
              echo "${WF_CONFLICTS}" | xargs -r git checkout --ours --
              echo "${WF_CONFLICTS}" | xargs -r git add --
            fi

            if [ -n "${OTHER_CONFLICTS}" ]; then
              echo "Resolving other conflicts by taking UPSTREAM (theirs):"
              echo "${OTHER_CONFLICTS}"
              echo "${OTHER_CONFLICTS}" | xargs -r git checkout --theirs --
              echo "${OTHER_CONFLICTS}" | xargs -r git add --
            fi
          fi

          # מחזירים את ה-workflows בדיוק כמו שהיו אצלך (כדי שלא ננסה לעדכן workflows של upstream)
          mkdir -p .github/workflows
          rsync -a --delete "/tmp/local-workflows/" ".github/workflows/" || true

          # מבטיחים שאין שינויי workflows בסטייג'
          git reset HEAD -- .github/workflows || true
          git checkout -- .github/workflows || true

          # מוסיפים את כל השינויים (מלבד workflows שנשארו נקיים)
          git add -A

          # אם אין מה לקמפליט – יוצאים בלי push
          if git diff --cached --quiet; then
            echo "No upstream changes to apply. Exiting."
            exit 0
          fi

          git commit -m "Sync upstream master (keep local workflows)"

      - name: Push to fork
        run: |
          git push origin master
