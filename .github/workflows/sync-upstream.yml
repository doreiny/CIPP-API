name: Sync upstream CIPP-API (keep local workflows)

on:
  schedule:
    - cron: "0 3 * * *"   # פעם ביום UTC
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-upstream
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Backup local workflows (we must not touch them)
        run: |
          mkdir -p /tmp/workflows
          if [ -d ".github/workflows" ]; then
            rsync -a ".github/workflows/" /tmp/workflows/
          fi

      - name: Add upstream & fetch (NO TAGS)
        run: |
          git remote add upstream https://github.com/KelvinTegelaar/CIPP-API.git 2>/dev/null || true
          git fetch upstream master --prune --no-tags

      - name: Merge upstream/master (prefer upstream), then restore local workflows
        shell: bash
        run: |
          set -euo pipefail

          # נסה למזג בלי קומיט כדי שנוכל להחזיר workflows לפני שמסיימים
          if git merge upstream/master --no-commit -X theirs; then
            echo "Merge staged (no-commit)."
          else
            echo "Merge had conflicts. We'll restore workflows and fail only if other conflicts remain."
          fi

          # להחזיר workflows המקומיים בדיוק כמו שהיו
          if [ -d "/tmp/workflows" ] && [ "$(ls -A /tmp/workflows 2>/dev/null)" ]; then
            rm -rf .github/workflows
            mkdir -p .github/workflows
            rsync -a /tmp/workflows/ .github/workflows/
          fi

          # אם עדיין יש קונפליקטים (מחוץ ל-workflows) – עוצרים
          if git ls-files -u | grep -q .; then
            echo "Conflicts remain after restoring workflows. Manual resolution needed."
            git status
            exit 1
          fi

          git add -A

          # אם יש merge במצב פתוח (MERGE_HEAD) – נסיים אותו תמיד
          if git rev-parse -q --verify MERGE_HEAD >/dev/null 2>&1; then
            git commit --allow-empty -m "Merge upstream/master into master (keep local workflows)"
          else
            # אם אין merge פתוח, ניצור קומיט רק אם יש שינוי אמיתי
            if ! git diff --cached --quiet; then
              git commit -m "Sync upstream/master (keep local workflows)"
            else
              echo "Already up to date."
              exit 0
            fi
          fi

      - name: Push branch (NO TAGS)
        run: |
          git push origin master
